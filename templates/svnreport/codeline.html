{% extends "base.html" %}{% load i18n %}
{% load pagination_tags %}
{% block content %}
<div class="container">
    <ol class="breadcrumb">
        <li><a href="/">Home</a></li>
        <li><a href="/svnreport">SVNReport</a></li>
        <li class="active">Codeline</li>
    </ol>
    <div class="page-header">
        <h3>
            <span>SVN代码量报告</span>
            <span><small> svn代码量统计</small></span>
        </h3>
    </div>
    <div class="row">
        <div class="col-md-2"></div>
        <div class="col-md-2">
            <div class="block-header">部门</div>
            <div class="image-count" style="background:#00aacc;">{{ count_department }}</div>
        </div>
        <div class="col-md-2">
            <div class="block-header">项目组</div>
            <div class="image-count" style="background:#9ACD32;">{{ count_groups }}</div>
        </div>
        <div class="col-md-2">
            <div class="block-header">开发人员</div>
            <div class="image-count" style="background:#CD5C5C;">{{ count_users }}</div>
        </div>
        <div class="col-md-2">
            <div class="block-header">语言</div>
            <div class="image-count" style="background:#DAA520;">{{ count_language }}</div>
        </div>
        <div class="col-md-2"></div>
    </div>
    <br/>
    <legend>{% trans "代码量趋势统计" %}</legend>
    <div id="container-codeline" ></div>
    <legend>{% trans "部门代码量统计" %}</legend>
    <div id="container-department" ></div>
    <legend>{% trans "语言分布统计" %}</legend>
    <div id="container-language" style="height:1200px;"></div>


<script>
    $(function(){
        var codelineset = {{ codelineset|safe }};
        var len = codelineset.length;
        var date = {{ date|safe }};

        var datelist= new Array();
        var json = {};
        for(var i=0;i<len;i++){
            if(!json[codelineset[i][0]]){
                datelist.push(codelineset[i][0]);
                json[codelineset[i][0]] = 1;
            }
        }

        function generateSeries(codelineset){
            var series = new Array(),
            len = codelineset.length,
            map = {};

            for(var i=0; i<len; i++){
                if(! (codelineset[i][1] in map)){
                    map[codelineset[i][1]] = [];
                }
                var date = new Date(codelineset[i][0]),
                year = date.getFullYear(),
                month = date.getMonth() + 1,
                day = date.getDate();
                
                map[codelineset[i][1]].push([Date.UTC(year,month,day),codelineset[i][2]])
            }
            for(var key in map){
                series.push({
                    name: key,
                    data: map[key]
                 });
            }
            return series
        }

        var series = generateSeries(codelineset);
        $('#container-codeline').highcharts({
            chart: {
                type: 'line'
            },
            title: {
                text: '代码量趋势统计'
            },
            subtitle: {
                text: '各部门代码量'
            },
            xAxis: {
                type: 'datetime',
                dateTimeLabelFormats:{
                    day: '%b-%e',
                }
            },
            yAxis: {
                min: 0,
                title: {
                    text: 'code line'
                }
            },
            tooltip: {
                enabled: true,
                formatter: function() {
                    return '<b>'+ this.series.name +'</b><br/>'+
                      Highcharts.dateFormat('%Y-%b-%e',this.x)+':'+this.y;
                }
            },
            series: series
        });

        var departmentset = {{ departmentset|safe }};
        var dplist= new Array();
        for(var key in departmentset)
        {
            dplist.push(key);
        }


        var colors = Highcharts.getOptions().colors,
        categories = dplist,
        name = '部门';

        function generateData(dataset){
            var data = new Array();
            var i = 0;
            for (var key in dataset){
                var groupname = new Array(),
                groupdata = new Array(),
                totaldata = 0;
                for (var k in dataset[key]){
                    groupname.push(k);
                    groupdata.push(dataset[key][k]);
                    totaldata += dataset[key][k];
                }
                
                data.push({
                    y: totaldata,
                    color: colors[i],
                    drilldown: {
                        name: key,
                        categories: groupname,
                        data: groupdata,
                        color: colors[i]
                    }
                });
                i++;
            }
            return data;
        };
        var data = generateData(departmentset);

        function setChart(name, categories, data, color) {
            chart.xAxis[0].setCategories(categories, false);
            chart.series[0].remove(false);
            chart.addSeries({
                name: name,
                data: data,
                color: color || 'white'
            },false);
            chart.redraw();
        }

        
        var chart = $('#container-department').highcharts({
            chart:{
                type: 'column'
            },
            title:{
                text: '部门代码量统计报告'
            },
            subtitle:{
                text: '点击列柱查看语言信息，再次单击返回'+'  (日期: ' + date + ')'
            },
            xAxis:{
                categories: categories
            },
            yAxis:{
                title:{
                    text: 'code line'
                },
            },
            tooltip: {
                formatter: function() {
                    var point = this.point,
                    s = this.x + ':<b>' + this.y + ' code lines</b><br/>';
                    if (point.drilldown) {
                        s += 'Click to view '+ point.category ;
                    } else {
                        s += 'Click to return';
                    }
                    return s;
                }
            },
            plotOptions: {
                column: {
                    cursor: 'pointer',
                    point: {
                        events: {
                            click : function() {
                                var drilldown = this.drilldown;
                                if (drilldown) { // drill down
                                    setChart(drilldown.name, drilldown.categories, drilldown.data, drilldown.color);
                                    } else { // restore
                                    setChart(name, categories, data);
                                }
                            } //end function
                        } // end events
                    },
                    dataLabels: {
                        enabled: true,
                        color: colors[0],
                        style: {
                            fontWeight: 'bold'
                        },
                        formatter: function() {
                            return this.y ;
                        }
                    }
                }
            },
            series: [{
                name: name,
                data: data,
                color: 'white'
            }],
            exporting: {
                enabled: false
            }
        })
        .highcharts();

        var languageset = {{ languageset|safe }},
        languagename = new Array(),
        languagedata = new Array(),
        len = languageset.length;
        for(var i=0; i<len; i++){
            languagename.push(languageset[i][0]);
            languagedata.push(languageset[i][1]);
        }
        $('#container-language').highcharts({
            chart:{
                type: 'bar'
            },
            title:{
                text: '语言分布统计报告'
            },
            subtitle:{
                text: '(日期: ' + date + ')'
            },
            xAxis:{
                min: 0,
                categories: languagename
            },
            yAxis:{
                title:{
                    text: 'code line'
                },
            },
            tooltip: {
                valueSuffix: 'code line'
            },
            plotOptions: {
                bar: {
                    dataLabels: {
                        enabled: true,
                    }
                }
            },
            series: [{
                name: 'Language' ,
                data: languagedata,
                color: '#4897f1'
            }]
        });
    });
</script>
{% endblock %}
